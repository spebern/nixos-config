#+title:  NixOS System Configuration Flake

#+attr_org: :width 600
[[file:rsc/Header.svg]]

* Table of Content :toc:
- [[#flakes][Flakes]]
  - [[#partitioning][Partitioning]]
  - [[#installation][Installation]]
  - [[#finalization][Finalization]]

* Flakes
Flakes can be build with:
- ~$ sudo nixos-rebuild switch --flake <path>#<hostname>~
- example ~$ sudo nixos-rebuild switch --flake .#desktop~

** Partitioning
This will depend on the host chosen.
*** UEFI
*In these commands*
- Partition Labels:
  - Boot = "boot"
  - Home = "nixos"
- Partition Size:
  - Boot = 512MiB
  - Swap = 8GiB
  - Home = Rest
- No Swap: Ignore line 3 & 7

#+begin_src
# parted /dev/sda -- mklabel gpt
# parted /dev/sda -- mkpart primary 512MiB -8GiB
# parted /dev/sda -- mkpart primary linux-swap -8GiB 100%
# parted /dev/sda -- mkpart ESP fat32 1MiB 512MiB
# parted /dev/sda -- set 3 esp
# mkfs.ext4 -L nixos /dev/sda1
# mkswap -L /dev/sda2
# mkfs.fat -F 32 -n boot /dev/sda3
#+end_src

*** Legacy
*In these commands*
- Partition Label:
  - Home & Boot = "nixos"
  - Swap = "swap"
- Partition Size:
  - Swap = 8GiB
  - Home = Rest
- No swap: Ignore line 3 and 5

#+begin_src
# parted /dev/sda -- mklabel msdos
# parted /dev/sda -- mkpart primary 1MiB -8GiB
# parted /dev/sda -- mkpart primary linux-swap -8GiB 100%
# mkfs.ext4 -L nixos /dev/sda1
# mkswap -L /dev/sda2
#+end_src

** Installation
*** Generate
*In these commands*
- Swap is enable:
  - Ignore if no swap or enough RAM
- Configuration files are generated @ ~/mnt/etc/nixos~
  - If you are me, you don't need to do this. Hardware-configuration.nix already in flake.
- Clone repository
#+begin_src
# swapon /dev/sda2
# nixos-generate-config --root /mnt
# nix-env -iA nixos.git
# git clone https://github.com/matthiasbenaets/nixos-config /mnt/etc/nixos/<name>

Optional if you are not me
# cp /mnt/etc/nixos/hardware-configuration.nix /mnt/etc/nixos/nixos-config/hosts/<host>/.
#+end_src

*** Possible Extra Steps
1. Switch specific host hardware-configuration.nix with generated ~/mnt/etc/nixos/hardware-configuration.nix~
2. Change existing network card name with the one in your system
   - Look in generated hardware-configuration.nixos
   - Or enter ~$ ip a~
3. Change username in flake.nix
4. Set a ~users.users.${user}.initialPassword = ...~
   - Not really recommended. It's maybe better to follow last steps
5. If you are planning on using default2.nix doom emacs, don't forget to rebuild after the initial installation when you link to this nix file.
   - Don't forget to change the flake location in flake.nix
   - This is because userActivationScript is used for the setup and some locations are partially hardcoded
   - It will automatically install if ~~/.emacs.d~ does not exist

*** Install
*In these commands*
- Move into cloned repository
  - in this example ~/mnt/etc/nixos/<name>~
- Available hosts:
  - desktop
  - laptop
  - vm
#+begin_src
# cd /mnt/etc/nixos/<name>
# nixos-install --flake .#<host>
#+end_src

** Finalization
1. Set a root password after installation is done
2. Reboot without livecd
3. Login
   1. If initialPassword is not set use TTY:
      - ~Ctrl - Alt - F1~
      - login as root
      - ~# passwd <user>~
      - ~Ctrl - Alt - F7~
      - login as user
4. Optional:
   - ~$ sudo mv <location of cloned directory> <prefered location>~
   - ~$ sudo chown -R <user>:users <new directory>~
   - ~$ sudo rm /etc/nixos/configuration.nix~
   - or just clone flake again do apply same changes.
5. Dual boot:
   - OSProber probably did not find your Windows partion after the first install
   - There is a high likelyhood it will find it after:
     - ~$ cd <repo directory>~
     - ~$ sudo nixos-rebuild switch --flake .#<host>~
6. Rebuilds:
   - ~<flakelocation>$ sudo nixos-rebuild switch --flake .#<host>~
